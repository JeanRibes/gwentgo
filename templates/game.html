<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HTML5 Gwynt</title>
    <style>
        body {
            color: white;
            --card-height: 5.5rem;
            --card-width: 4.5rem;
        }

        img.card {
            display: block;
            margin: auto;
            border-radius: 0.4rem;
            height: var(--card-height);
            width: var(--card-width);
            object-fit: cover;
            object-position: 0 0;
        }

        figure.card {
            transition: 0.2s ease-in-out;
            margin: 0;
            padding: 0;
            width: var(--card-width);
            height: var(--card-height);
        }

        figcaption.card {
            display: block;
            position: fixed;
            right: 0;
            top: 10vh;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem;
            background-color: black;
            color: white;
            width: 20rem;
            box-shadow: 5px 5px 10px black, -5px -5px 10px black;

            opacity: 0;
        }

        figure.card:hover > img.card {
            transform: scale(2);
            transition: .2s ease-in-out;
            height: unset;
            z-index: 1;
        }
        /*td.card:nth-child(2) > figure.card > img.card {
            z-index: 1;
            height: unset;
        }*/

        figure.card:hover > figcaption.card {
            opacity: 100%;
            transition: 0.2s ease-in-out;
            z-index: 2;
        }

        body {
            background-color: saddlebrown;
        }

        tr.drag-dest {
            max-height: var(--card-height);
        }
        td.drag-indicator {
            color: black;
            background-color: #e5cdae;
            height: var(--card-height);
            text-align: center;
        }
        #gametable > *{
            display: inline-block;
            vertical-align: top;
        }
    </style>
</head>

<body>
<a href="/demo">refresh</a>
{{template "table.html" .}}

<form id="form-play-move" action="{{.Url}}" method="post">
    <label for="card-id">Card ID to play</label>
    <input name="id" id="card-id" type="number">

    <label for="card-row">Row to play card (CloseCombat, RangedCombat, Siege)</label>
    <input name="row" id="card-row" type="text">
    <button id="form-play-submit" type="submit">Play</button>
</form>
</body>
<script>
    function startDragCard(event, row, cardid) {
        let target = event.target
        if (!target.classList.contains('draggable')){
            target = target.parentNode;
        }
        // when the user starts to drag a card
        event.dataTransfer.setData("id", target.id);
        event.dataTransfer.setData("row", row);
        event.dataTransfer.setData("cardid", cardid);
        event.dataTransfer.dropEffect = "move";
        if (row !== 'Special') {
            document.getElementById(row).style.background = "yellow";
        } else {
            document.getElementById('CloseCombat').style.background = "yellow";
            document.getElementById('RangedCombat').style.background = "yellow";
        }
    }

    function dropCard(event) {
        event.preventDefault();
        event.target.style.background = "";
        let target = event.target;
        if (!target.classList.contains("drag-dest")) {
            target = event.target.parentElement;
        } else {
            target = event.target;
        }
        if (target.classList.contains(event.dataTransfer.getData("row"))) {
            let td = document.createElement('td');
            td.className = "card";
            let fig = document.getElementById(event.dataTransfer.getData("id"))
            fig.draggable = false;
            fig.childNodes.forEach((child)=>{child.draggable=false})
            fig.classList.remove('draggable')
            td.appendChild(fig)
            target.appendChild(td);
            //target.appendChild(document.getElementById(event.dataTransfer.getData("id")))
            let target_row = target.id;
            playMove(event.dataTransfer.getData("cardid"),target_row)
        }
    }

    function onDragOver(event) {
        event.preventDefault();
    }

    function onDragEnter(event) {
        //when a dragged card arrives on top of a DnD target
        ////event.target.classList.add("dragover") marche pas
        if (event.target.classList.contains(event.dataTransfer.getData("row"))) {
            event.target.style.background = "green"
        } else {
            event.target.style.background = "red"
        }

    }

    function onDragLeave(event) {
        //when a dragged card leaves a DnD target
        ////event.target.classList.remove("dragover") marche pas
        try {
            event.target.style.background = ""
        } catch (e) {

        }

    }

    function endDragCard(event, row) {
        // when the user starts to drag a card
        if (row !== 'Special') {
            let elem = document.getElementById(row);
            if (elem !== null || elem !== undefined) {
                elem.style.background = "";
            }
        }
    }
    function playMove(id,row){
        console.log("move: ",id,row)
        document.getElementById('card-row').value = row;
        document.getElementById('card-id').value = id;
        //document.getElementById("form-play-submit").click()
        htmx.ajax('POST', '{{.Url}}', {
            target: '#gametable',
            values: {
                "row":row,
                "id":id,
            }
        })
    }
</script>
<script src="https://unpkg.com/htmx.org@1.6.1"></script>
</html>