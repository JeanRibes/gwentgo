<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deck building</title>
    <link href="/static/deck.css" rel="stylesheet"/>
</head>
<body>
<a href="/deck/{{.PrevDeck}}">Previous</a>
<a href="/deck/{{.NextDeck}}">Next</a>
<h1>{{.Name}}</h1>
<em>{{.Faction}}</em>

<div class="twocolumn">
    <form action="." method="post">
        <label for="name-input">Name</label>
        <input id="name-input" name="name" value="{{.Name}}">

        <label for="faction-input">Faction</label>
        <select id="faction-input" name="faction">
            <option selected value="">(unchanged)</option>
            <option value="NorthernRealms">NorthernRealms</option>
            <option value="Nilfgaard">Nilfgaard</option>
            <option value="ScoiaTael">Scoia'Tael</option>
            <option value="Monsters">Monsters</option>
        </select>

        <button type="submit">Change</button>
    </form>

    <form action="/deck/" method="post">
        <label for="faction-input2">Faction</label>
        <select id="faction-input2" name="faction">
            <option value="NorthernRealms">Northern Realms</option>
            <option value="Nilfgaard">Nilfgaard</option>
            <option value="ScoiaTael">Scoia'Tael</option>
            <option value="Monsters">Monsters</option>
        </select>
        <button type="submit">Add new deck</button>
    </form>
</div>

<header class="twocolumn">
    <h1>All Cards</h1>
    <h1>Deck</h1>
</header>

<main class="twocolumn">
    <section class="drop-dest"
             id="rest"
             ondragover="onDragOver(event)"
             ondrop="dropCard(event)">

        {{range .Rest}}
        <img class="card" draggable="true"
             id="card-{{.Id}}"
             ondblclick="doubleClick(event, '{{.Id}}')"
             ondragend="endDragCard(event)"
             ondragstart="startDragCard(event,'{{.Id}}')" src="/static/{{.Picture}}"/>
        {{end}}

    </section>
    <section
            class="drop-dest"
            id="deck"
            ondragover="onDragOver(event)"
            ondrop="dropCard(event)">

        {{range .Deck}}
        <img class="card" draggable="true"
             id="card-{{.Id}}"
             ondblclick="doubleClick(event, '{{.Id}}')"
             ondragend="endDragCard(event)"
             ondragstart="startDragCard(event,'{{.Id}}')" src="/static/{{.Picture}}"/>
        {{end}}

    </section>
</main>
<script>
    function doubleClick(event, cardid) {
        if (event.target.parentNode.id === 'rest') {
            fetch('add/' + cardid, {
                method: "POST"
            }).then(r => console.log(r.url))

            let fig = document.getElementById(event.target.id)
            document.getElementById('deck').appendChild(fig);
            return;
        }

        if (event.target.parentNode.id === 'deck') {
            fetch('remove/' + cardid, {
                method: "POST"
            }).then(r => console.log(r.url))

            let fig = document.getElementById(event.target.id)
            document.getElementById('rest').appendChild(fig);
            return;
        }
    }

    function startDragCard(event, cardid) {
        event.dataTransfer.setData("id", event.target.id);
        event.dataTransfer.setData("cardid", cardid);
        event.dataTransfer.setData("parentid", event.target.parentNode.id)
        event.dataTransfer.dropEffect = "move";

        if (event.target.parentNode.id === 'rest') {
            let indic = document.createElement('div');
            indic.id = 'indic';
            indic.innerText = ""
            indic.classList.add('card')
            document.getElementById('deck').appendChild(indic);
        }
    }

    function dropCard(event) {
        event.preventDefault();
        let target = event.target;
        if (!target.classList.contains('drop-dest')) {
            target = target.parentNode
        }

        if (target.id === event.dataTransfer.getData('parentid')) {
            return
        }

        let fig = document.getElementById(event.dataTransfer.getData("id"))
        target.appendChild(fig);

        if (target.id === 'deck') {
            fetch('add/' + event.dataTransfer.getData("cardid"), {
                method: "POST"
            }).then(console.log)
        }
        if (target.id === 'rest') {
            fetch('remove/' + event.dataTransfer.getData("cardid"), {
                method: "POST"
            }).then(console.log)
        }
    }

    function endDragCard(event) {
        document.getElementById('indic').remove();
    }

    function onDragOver(event) {
        event.preventDefault();

        /*if (event.target.classList.contains('drop-dest')){
            if(event.target.id !== event.dataTransfer.getData('parentid')){
                //valid transfer
                let indic = document.createElement('div');
                indic.id='indic';
                indic.innerText="placeholder"
                event.target.appendChild(indic);
            }
        }*/

    }
</script>

<pre>
    <code>
{{range .Deck}}
{{.Id}},{{end}}
    </code>
</pre>

</body>
</html>